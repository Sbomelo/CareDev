@model CareDev.Models.ViewModels.MovementCreateViewModel
@{
    ViewData["Title"] = "Move Patient";
    var wards = (SelectList)ViewBag.Wards;
    var beds = (List<Bed>)ViewBag.Beds;
}
<div class="text-center mb-3">
    <h2>Move Patient</h2>
</div>
<hr />
<div class="card bg-white shadow-lg border-0 rounded-5 mb-3 p-3">
    <dl class="row">
        <dt class="col-sm-3">Patient Name:</dt>
        <dd class="col-sm-9">@Model.PatientName</dd>

        <dt class="col-sm-3">Current Ward: </dt>
        <dd class="col-sm-9">@Model.FromWardName</dd>

        <dt class="col-sm-3">Current Bed: </dt>
        <dd class="col-sm-9">@Model.FromBedNumber</dd>
    </dl>
</div>

<form asp-action="Create" method="post"
      data-confirm-on-submit="true"
      data-confirm-title="Move Patient"
      data-confirm-message="Are you sure you want to move @Model.PatientName"
      data-confirm-text="Yes"
      data-confirm-class="btn-primary">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="AdmissionId" />
    <input type="hidden" asp-for="PatientId" />

    <div class="mb-3">
        <label asp-for="ToWardId" class="form-label"></label>
        <select asp-for="ToWardId" class="form-control" asp-items="wards" id="wardSelect"></select>
    </div>

    <div class="mb-3">
        <label asp-for="ToBedId" class="form-label"></label>
        <select asp-for="ToBedId" class="form-control" id="bedSelect">
            <option value="">-- select bed --</option>
            @foreach(var b in beds)
            {
                if (!b.IsAvailable)
                {
                    <option value="@b.BedId" data-ward="@b.WardId" disabled>
                        @(b.Ward?.Name ?? "—") / @b.BedNumber (occupied)
                    </option>
                }
                else
                {
                    <option value="@b.BedId" data-ward="@b.WardId">
                        @(b.Ward?.Name ?? "—") / @b.BedNumber
                    </option>
                }
            }
        </select>
        <small class="form-text text-muted">Only available beds are selectable (occupied beds are disabled).</small>
    </div>

    <div class="mb-3">
        <label asp-for="MovedAt" class="form-label"></label>
        <input asp-for="MovedAt" class="form-control" type="datetime-local" value="@(Model.MovedAt?.ToLocalTime().ToString("yyyy-MM-ddTHH:mm"))"/>
    </div>

    <div class="mb-3">
        <label asp-for="Reason" class="form-label"></label>
        <textarea asp-for="Reason" class="form-control" rows="3"></textarea>
    </div>
    <div class="text-center d-flex justify-content-center">
        <button type="submit" class="btn btn-primary w-50 rounded-pill me-1">Move Patient</button>
        <a asp-action="Index" class="btn btn-dark w-50 rounded-pill">Back</a>
    </div>

</form>

@section Scripts {
    <script>
        //filter: show beds of selected ward
        const wardSelect = document.getElementById('wardSelect');
        const bedSelect = document.getElementById('bedSelect');

        function filterBeds() {
            const wardId = wardSelect.value;
            for (const opt of bedSelect.options) {
                const optWard = opt.getAttribute('data-ward');

                if (!wardId || optWard === wardId) {
                    opt.style.display = '';
                } else {
                    opt.style.display = 'none';
                }
            }

            for (const opt of bedSelect.options) {
                if (opt.style.display === '') { bedSelect.value = opt.value; break; }
            }
        }

        wardSelect.addEventListener('change', filterBeds);
        window.addEventListener('load', filterBeds);
    </script>
}
